name: Hugo Deploy to Cloudflare Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  HUGO_VERSION: '0.120.0'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: ${{ env.HUGO_VERSION }}
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies (if needed)
      run: |
        if [ -f "package.json" ]; then
          npm ci
        fi

    - name: Build website
      run: hugo --minify

    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: muyueji
        directory: public
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  deploy-videos:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY }}
        aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_KEY }}
        aws configure set default.region auto

    - name: Upload videos to R2
      run: |
        # 检查是否有视频文件
        if [ -d "static/videos" ] && [ "$(ls -A static/videos)" ]; then
          echo "发现视频文件，开始上传到 R2..."
          
          # 创建映射文件
          echo "# 视频文件映射" > video_url_mapping.txt
          
          # 遍历视频文件并上传
          find static/videos -type f \( -name "*.mp4" -o -name "*.webm" -o -name "*.mov" -o -name "*.avi" -o -name "*.mkv" \) | while read video_file; do
            relative_path=${video_file#static/videos/}
            
            # 上传到 R2
            if aws s3 cp "$video_file" "s3://${{ secrets.R2_BUCKET }}/videos/$relative_path" \
                --endpoint-url "https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
                --no-progress; then
              
              # 记录映射关系
              cdn_url="${{ secrets.R2_CDN_DOMAIN }}/videos/$relative_path"
              echo "$relative_path|$cdn_url" >> video_url_mapping.txt
              echo "✅ 上传成功: $relative_path -> $cdn_url"
            else
              echo "❌ 上传失败: $relative_path"
            fi
          done
        else
          echo "没有找到视频文件，跳过上传"
        fi

    - name: Update video links in articles
      run: |
        # 如果有映射文件，更新文章中的视频链接
        if [ -f "video_url_mapping.txt" ] && [ -s "video_url_mapping.txt" ]; then
          echo "更新文章中的视频链接..."
          python3 scripts/replace_video_links.py
        else
          echo "没有视频映射文件，跳过链接更新"
        fi

    - name: Commit and push changes
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        if git diff --staged --quiet; then
          echo "没有需要提交的更改"
        else
          git commit -m "自动更新视频链接 [skip ci]"
          git push
        fi

  enable-discussions:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Enable GitHub Discussions
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          try {
            const result = await github.rest.repos.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              allow_auto_merge: true,
              allow_squash_merge: true,
              allow_merge_commit: false,
              allow_rebase_merge: false,
              delete_branch_on_merge: true,
              has_issues: true,
              has_projects: false,
              has_wiki: false,
              has_pages: true,
              has_discussions: true
            });
            console.log('Discussions enabled successfully');
          } catch (error) {
            console.log('Discussions might already be enabled:', error.message);
          }