name: Hugo Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      hugo-output: ${{ steps.build.outputs.path }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.120.0'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies (if needed)
      run: |
        if [ -f "package.json" ]; then
          npm ci
        fi

    - name: Build website
      id: build
      run: |
        hugo --minify --verbose
        echo "hugo-output=public" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        echo "ğŸ“ æ„å»ºæ–‡ä»¶åˆ—è¡¨ï¼š"
        find public -type f | head -20
        
        echo "ğŸ“Š æ„å»ºç»Ÿè®¡ï¼š"
        echo "æ–‡ä»¶æ•°é‡: $(find public -type f | wc -l)"
        echo "æ€»å¤§å°: $(du -sh public | cut -f1)"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: hugo-output
        path: public/
        retention-days: 1

    - name: Archive build output
      run: |
        tar -czf hugo-build.tar.gz public/
        echo "ğŸ“¦ æ„å»ºæ–‡ä»¶å·²æ‰“åŒ…: hugo-build.tar.gz"

    - name: Upload archive
      uses: actions/upload-artifact@v3
      with:
        name: hugo-archive
        path: hugo-build.tar.gz
        retention-days: 1

  deploy-pages:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: hugo-output
        path: public

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: public
        retention-days: 30

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  deploy-cloudflare:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: hugo-output
        path: public

    - name: Deploy to Cloudflare Pages
      id: cf-deploy
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME || 'muyueji' }}
        directory: public
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        # ç¦ç”¨ Wranglerï¼Œä½¿ç”¨ç›´æ¥ä¸Šä¼ 
        wranglerVersion: '3'

    - name: Cloudflare Pages Output
      run: |
        echo "ğŸŒ Cloudflare Pages éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "é¡¹ç›®åç§°: ${{ secrets.CLOUDFLARE_PROJECT_NAME || 'muyueji' }}"
        echo "è´¦æˆ·ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
        if [ "${{ steps.cf-deploy.outputs.url }}" != "" ]; then
          echo "éƒ¨ç½²URL: ${{ steps.cf-deploy.outputs.url }}"
        fi
        echo "éƒ¨ç½²æ—¶é—´: $(date -u)"

  deploy-video-r2:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY }}
        aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_KEY }}
        aws configure set default.region auto

    - name: Upload videos to R2
      env:
        R2_ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
      run: |
        if [ -d "static/videos" ] && [ "$(ls -A static/videos)" ]; then
          echo "ğŸ¬ å‘ç°è§†é¢‘æ–‡ä»¶ï¼Œå¼€å§‹ä¸Šä¼ åˆ° R2..."
          
          # åˆ›å»ºæ˜ å°„æ–‡ä»¶
          echo "# è§†é¢‘æ–‡ä»¶æ˜ å°„" > video_url_mapping.txt
          
          # éå†è§†é¢‘æ–‡ä»¶å¹¶ä¸Šä¼ 
          find static/videos -type f \( -name "*.mp4" -o -name "*.webm" -o -name "*.mov" -o -name "*.avi" -o -name "*.mkv" \) | while read video_file; do
            relative_path=${video_file#static/videos/}
            
            echo "ğŸ“¤ ä¸Šä¼ : $relative_path"
            
            # ä¸Šä¼ åˆ° R2
            if aws s3 cp "$video_file" "s3://${{ secrets.R2_BUCKET }}/videos/$relative_path" \
                --endpoint-url "$R2_ENDPOINT" \
                --no-progress; then
              
              # è®°å½•æ˜ å°„å…³ç³»
              cdn_url="${{ secrets.R2_CDN_DOMAIN }}/videos/$relative_path"
              echo "$relative_path|$cdn_url" >> video_url_mapping.txt
              echo "âœ… ä¸Šä¼ æˆåŠŸ: $relative_path"
            else
              echo "âŒ ä¸Šä¼ å¤±è´¥: $relative_path"
            fi
          done
          
          echo "ğŸ“‹ è§†é¢‘æ˜ å°„æ–‡ä»¶ï¼š"
          cat video_url_mapping.txt
        else
          echo "ğŸ“¹ æ²¡æœ‰æ‰¾åˆ°è§†é¢‘æ–‡ä»¶ï¼Œè·³è¿‡ä¸Šä¼ "
        fi

    - name: Update video links (if videos uploaded)
      if: success()
      run: |
        if [ -f "video_url_mapping.txt" ] && [ -s "video_url_mapping.txt" ]; then
          echo "ğŸ”„ æ›´æ–°æ–‡ç« ä¸­çš„è§†é¢‘é“¾æ¥..."
          python3 scripts/replace_video_links.py
        else
          echo "â­ï¸ æ²¡æœ‰è§†é¢‘æ˜ å°„æ–‡ä»¶ï¼Œè·³è¿‡é“¾æ¥æ›´æ–°"
        fi

  status-check:
    needs: [build, deploy-cloudflare, deploy-video-r2]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check deployment status
      run: |
        echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€æ€»ç»“ï¼š"
        echo "ğŸ—ï¸  Hugo æ„å»º: ${{ needs.build.result }}"
        echo "â˜ï¸  Cloudflare Pages: ${{ needs.deploy-cloudflare.result }}"
        echo "ğŸ“¹  è§†é¢‘ä¸Šä¼ : ${{ needs.deploy-video-r2.result }}"
        
        if [[ "${{ needs.build.result }}" == "success" && ("${{ needs.deploy-cloudflare.result }}" == "success" || "${{ needs.deploy-cloudflare.result }}" == "skipped") ]]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
        else
          echo "âŒ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
          exit 1
        fi