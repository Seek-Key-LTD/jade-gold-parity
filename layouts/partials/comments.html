{{- $commentsEnabled := .Site.Params.comments.enabled | default false -}}
{{- $discussionsRepo := .Site.Params.discussions.repo | default "" -}}
{{- $discussionsCategoryId := .Site.Params.discussions.categoryId | default "" -}}

{{- if and $commentsEnabled $discussionsRepo $discussionsCategoryId -}}
<!-- GitHub Discussions Comments -->
<div class="comments-container">
  <h3>è®¨è®ºåŒº</h3>
  <p>æ¬¢è¿åœ¨ <a href="https://github.com/{{ $discussionsRepo }}/discussions/categories/{{ $discussionsCategoryId }}" target="_blank" rel="noopener noreferrer">GitHub Discussions</a> ä¸­å‚ä¸è®¨è®ºï¼</p>
  
  <div id="github-discussions">
    <div class="discussion-loading">æ­£åœ¨åŠ è½½è®¨è®º...</div>
  </div>
  
  <script>
    // GitHub Discussions Integration
    (function() {
      const repo = '{{ $discussionsRepo }}';
      const categoryId = '{{ $discussionsCategoryId }}';
      const currentPath = window.location.pathname;
      const discussionTitle = document.title.replace(/ - [^-]+$/, ''); // ç§»é™¤ç½‘ç«™åç¼€
      
      // åˆ›å»ºè®¨è®ºé“¾æ¥
      function createDiscussionLink() {
        const discussionUrl = `https://github.com/${repo}/discussions/new?category=${categoryId}&title=${encodeURIComponent(discussionTitle)}&body=${encodeURIComponent(`å…³äºæ–‡ç« ï¼š${document.title}\n\né“¾æ¥ï¼š${window.location.href}\n\nè¯·åœ¨æ­¤å¤„åˆ†äº«æ‚¨çš„æƒ³æ³•...`)}`;
        
        return `<a href="${discussionUrl}" class="create-discussion-btn" target="_blank" rel="noopener noreferrer">
          ğŸ“ åˆ›å»ºæ–°è®¨è®º
        </a>`;
      }
      
      // è·å–ç›¸å…³è®¨è®º
      async function fetchDiscussions() {
        try {
          const query = `repo:${repo} ${discussionTitle}`;
          const apiUrl = `https://api.github.com/search/issues?q=${encodeURIComponent(query)}&sort=created&order=desc`;
          
          const response = await fetch(apiUrl, {
            headers: {
              'Accept': 'application/vnd.github.v3+json',
              'X-GitHub-Api-Version': '2022-11-28'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to fetch discussions');
          }
          
          const data = await response.json();
          displayDiscussions(data.items.filter(item => item.pull_request === undefined));
          
        } catch (error) {
          console.error('Error fetching discussions:', error);
          document.getElementById('github-discussions').innerHTML = `
            <div class="discussion-error">
              <p>æ— æ³•åŠ è½½è®¨è®ºï¼Œè¯· <a href="https://github.com/${repo}/discussions" target="_blank" rel="noopener noreferrer">è®¿é—® GitHub</a> æŸ¥çœ‹è®¨è®ºã€‚</p>
            </div>
          `;
        }
      }
      
      // æ˜¾ç¤ºè®¨è®ºåˆ—è¡¨
      function displayDiscussions(discussions) {
        const container = document.getElementById('github-discussions');
        
        if (discussions.length === 0) {
          container.innerHTML = `
            <div class="no-discussions">
              <p>è¿˜æ²¡æœ‰ç›¸å…³çš„è®¨è®ºã€‚${createDiscussionLink()}</p>
            </div>
          `;
          return;
        }
        
        let html = `<div class="discussion-list">${createDiscussionLink()}</div>`;
        
        discussions.slice(0, 5).forEach(discussion => {
          const createdAt = new Date(discussion.created_at).toLocaleDateString('zh-CN');
          const updatedAt = new Date(discussion.updated_at).toLocaleDateString('zh-CN');
          const replies = discussion.comments;
          
          html += `
            <div class="discussion-item">
              <div class="discussion-header">
                <a href="${discussion.html_url}" target="_blank" rel="noopener noreferrer" class="discussion-title">
                  ${discussion.title}
                </a>
                <div class="discussion-meta">
                  <span class="discussion-author">by ${discussion.user.login}</span>
                  <span class="discussion-date">${createdAt}</span>
                  ${replies > 0 ? `<span class="discussion-replies">${replies} å›å¤</span>` : ''}
                </div>
              </div>
              ${discussion.body ? `
                <div class="discussion-excerpt">
                  ${discussion.body.substring(0, 200)}${discussion.body.length > 200 ? '...' : ''}
                </div>
              ` : ''}
            </div>
          `;
        });
        
        container.innerHTML = html;
      }
      
      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('github-discussions').innerHTML = createDiscussionLink() + '<div class="discussion-loading">æ­£åœ¨åŠ è½½è®¨è®º...</div>';
        fetchDiscussions();
      });
    })();
  </script>
  
  <style>
    .comments-container {
      margin: 2rem 0;
      padding: 1.5rem;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    
    .comments-container h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #24292e;
    }
    
    .create-discussion-btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #0969da;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-weight: 500;
    }
    
    .create-discussion-btn:hover {
      background-color: #0860ca;
      color: white;
    }
    
    .discussion-list {
      margin-bottom: 1rem;
    }
    
    .discussion-item {
      margin: 1rem 0;
      padding: 1rem;
      background-color: white;
      border: 1px solid #d0d7de;
      border-radius: 6px;
    }
    
    .discussion-title {
      color: #0969da;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1em;
    }
    
    .discussion-title:hover {
      text-decoration: underline;
    }
    
    .discussion-meta {
      font-size: 0.9em;
      color: #656d76;
      margin-top: 0.25rem;
    }
    
    .discussion-meta span {
      margin-right: 1rem;
    }
    
    .discussion-replies {
      background-color: #ddf4ff;
      color: #0969da;
      padding: 0.125rem 0.375rem;
      border-radius: 2em;
      font-size: 0.85em;
    }
    
    .discussion-excerpt {
      margin-top: 0.5rem;
      color: #656d76;
      line-height: 1.5;
    }
    
    .discussion-loading,
    .discussion-error,
    .no-discussions {
      text-align: center;
      padding: 1rem;
      color: #656d76;
    }
    
    .discussion-error {
      color: #cf222e;
    }
    
    @media (max-width: 768px) {
      .comments-container {
        padding: 1rem;
      }
      
      .discussion-item {
        padding: 0.75rem;
      }
    }
  </style>
</div>
{{- end -}}